#!/bin/bash

#Check if ldap.config is already exit
#if [ ! -f /etc/squid3/ldap.config  ]
#then
	#Symbolic link to config LDAP
	cp /opt/ldap.config /etc/squid3/

	#Loading LDAP variable
	source /etc/squid3/ldap.config

	#Comment user deny to open proxy
	sed -i "s/^\(http_access deny all\)/# \1/g" /etc/squid3/squid.conf
	
	if ! grep -Fxq "forwarded_for off" /etc/squid3/squid.conf
	then
		#If set to off, Squid will dont append your client's IP address
		echo "forwarded_for off" >> /etc/squid3/squid.conf
	fi

	if $LDAP_ENABLE
	then
		echo "LDAP Enable"
		echo -e "auth_param basic program /usr/lib/squid3/basic_ldap_auth -b $LDAP_DN -f $LDAP_ATTRIBUT -h $LDAP_HOST:$LDAP_PORT\nauth_param basic children 5\nauth_param basic realm Your Proxy\nauth_param basic credentialsttl 2 hours\nacl ldapauth proxy_auth REQUIRED\nacl authenticated proxy_auth REQUIRED\nhttp_access allow ldapauth" >> /etc/squid3/squid.conf
	else
		#Add allow directive and fowarded_for
		echo "http_access allow all" >> /etc/squid3/squid.conf
	fi
#fi

#Launch squid on foreground
/usr/sbin/squid3 -NCd1 -f /etc/squid3/squid.conf
